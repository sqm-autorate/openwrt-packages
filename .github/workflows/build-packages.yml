name: build
run-name: Build openwrt packages
on: [pull_request, push]

env:
  OWRT_SDK: 'https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz'

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          path: "./feed"
      - name: Download SDK
        run: |
            mkdir -p ./sdk
            wget -O- "$OWRT_SDK" | tar --strip-components=1 -xJ -C ./sdk
      - name: Create feeds.conf
        run: |
            cp -v feeds.conf.default feeds.conf
            echo "src-link sqm-autorate $GITHUB_WORKSPACE/feed" >> feeds.conf
        working-directory: ./sdk
      - name: Update and install feeds
        run: |
            ./scripts/feeds update -a
            ./scripts/feeds install -a
        working-directory: ./sdk
      - name: Create default config
        run: make defconfig
        working-directory: ./sdk
      - name: Build lua-vstruct
        run: make package/lua-vstruct/compile
        working-directory: ./sdk
      - name: Build sqm-autorate
        run: make package/sqm-autorate/compile
        working-directory: ./sdk
